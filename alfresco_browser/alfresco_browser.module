<?php
// $Id$

/**
 * @file
 *
 */

/**
 * The default Alfresco home path.
 */
define('ALFRESCO_BROWSER_HOME', '/app:company_home');

/**
 * Implementation of hook_help().
 */
function alfresco_browser_help($path, $arg) {

  switch ($path) {
    case 'admin/help#alfresco_browser':
      return '<p>'. t('Allows users to visualize, search, browse and retrieve nodes of the Alfresco repository.') .'</p>';
  }
}

/**
 * Implementation of hook_perm().
 */
function alfresco_browser_perm() {

  return array('access alfresco browser');
}

/**
 * Implementation of hook_menu().
 */
function alfresco_browser_menu() {

  // Settings

  $items['admin/settings/alfresco/browser'] = array(
    'title' => 'Browser',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('alfresco_browser_admin_settings'),
    'access arguments' => array('administer alfresco'),
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
    'parent' => 'admin/settings/alfresco',
    'file' => 'alfresco_browser.admin.inc',
  );

  // Callbacks

  $items['alfresco/browser'] = array(
    'title' => 'Alfresco Browser Ext JS',
    'page callback' => 'alfresco_browser_page',
    'access callback' => 'user_access',
    'access arguments' => array('access alfresco browser'),
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/tree.json'] = array(
    'page callback' => 'alfresco_browser_service_tree_json',
    'access callback' => 'user_access',
    'access arguments' => array('access alfresco browser'),
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/grid.json'] = array(
    'page callback' => 'alfresco_browser_service_documents_json',
    'access callback' => 'user_access',
    'access arguments' => array('access alfresco browser'),
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/download'] = array(
    'page callback' => 'alfresco_browser_service_download',
    'access callback' => 'user_access',
    'access arguments' => array('access alfresco browser'),
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/upload'] = array(
    'page callback' => 'alfresco_browser_service_upload',
    'access callback' => 'user_access',
    'access arguments' => array('access alfresco browser'),
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/delete'] = array(
    'page callback' => 'alfresco_browser_service_delete',
    'access callback' => 'user_access',
    'access arguments' => array('access alfresco browser'),
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  // Pages

  $items['alfresco/repository'] = array(
    'title' => 'Repository browser',
    'description' => 'i18n Permite navegar, buscar y aÃ±adir contenido al repositorio de Alfresco.',
    'page callback' => 'alfresco_repository_browser_page',
    'access callback' => 'user_access',
    'access arguments' => array('access alfresco browser'),
    'file' => 'alfresco_browser.pages.inc',
  );

  return $items;
}

/**
 * Implementation of hook_theme
 */
function alfresco_browser_theme() {

  return array(
    'alfresco_browser' => array(
      'arguments' => array('element' => NULL),
    ),
    'alfresco_browser_page' => array(
      'arguments' => array(),
      'template' => 'browser/browser-page',
    ),
  );
}

/**
 * Process variables for browser-page.tpl.php.
 *
 * @see browser-page.tpl.php
 */
function template_preprocess_alfresco_browser_page(&$variables) {
  global $base_path, $language;

  $module_path = drupal_get_path('module', 'alfresco_browser');
  $extjs_path = module_exists('libraries') ? libraries_get_path('ext') : 'sites/all/libraries/ext';
  $locale_path = $extjs_path .'/source/locale/ext-lang-'. $language->language .'.js';

  $variables['title'] = t('Alfresco Browser for Drupal');
  $variables['header'] = l(t('Alfresco Browser for Drupal'), 'http://drupal.org/project/alfresco', array(
    'attributes' => array(
      'title' => t('Visit the official project page'),
      'target' => '_blank'
    )));

  $variables['base_path'] = $base_path;
  $variables['extjs_path'] = $base_path . $extjs_path;
  $variables['module_path'] = $base_path . $module_path;
  $variables['locale_path'] = file_exists('./'. $locale_path) ? $base_path . $locale_path : '';

  $variables['service_tree'] = url('alfresco/browser/service/tree.json');
  $variables['service_grid'] = url('alfresco/browser/service/grid.json');
  $variables['service_dl'] = url('alfresco/browser/service/download');
  $variables['service_ul'] = url('alfresco/browser/service/upload');
  $variables['service_del'] = url('alfresco/browser/service/delete');

  $variables['query_limit'] = variable_get('alfresco_browser_query_limit', 20);

  if ($homeNode = _alfresco_browser_load_home_node()) {
    $variables['home_ref'] = $homeNode->id;
    $variables['home_text'] = $homeNode->cm_name;
  }
  else {
    $variables['home_ref'] = '';
    $variables['home_text'] = '';
  }

  $info = drupal_parse_info_file($module_path .'/alfresco_browser.info');
  if (isset($info['version'])) {
    $variables['module_info'] = $info['name'] .' '. $info['version'];
  }
  else {
    $variables['module_info'] = $info['name'];
  }
}

/**
 * Implementation of hook_elements().
 */
function alfresco_browser_elements() {
  $type['alfresco_browser'] = array(
    '#input' => TRUE,
    '#default_value' => '',
    '#process' => array('alfresco_browser_process'),
    //'#element_validate' => array('alfresco_browser_element_validate'),
  );
  return $type;
}

/**
 * Our #process callback to expand the control.
 */
function alfresco_browser_process($element, $form_state) {

  drupal_add_js(array(
    'alfrescoBrowserUrl' => url('alfresco/browser'),
    'alfrescoBrowserName' => 'AlfrescoBrowserPopup',
    'alfrescoBrowserFeatures' => 'width=800,height=500,resizable',
  ), 'setting');

  drupal_add_js(drupal_get_path('module', 'alfresco_browser') .'/alfresco_browser.js');

  $element['alfresco_browser_reference'] = array(
    '#type' => 'hidden',
    '#name' => $element['#name'],
    '#value' => $element['#value']
  );

  // @todo Obtener nombre del fichero de base de datos
  $alfNode = alfresco_service_node_load($element['#value']);

  $element['alfresco_browser_path'] = array(
    '#type' => 'textfield',
    '#value' => $alfNode ? $alfNode->getFolderPath() . '/'. $alfNode->cm_name : '',
    '#attributes' => array('readonly' => TRUE),
  );

  $element['alfresco_browser_button'] = array(
    '#type' => 'markup',
    '#value' => '<input type="button" value="'. t('Browse...') .'" id="edit-alfresco-browser-button" />',
  );
  return $element;
}

/**
 *
 */
function theme_alfresco_browser($element) {
  return theme('form_element', $element, '<div class="container-inline">'. $element['#children'] .'</div>');
}

/**
 *
 */
function _alfresco_browser_load_home_node() {
  return alfresco_service_node_load(variable_get('alfresco_browser_home', ALFRESCO_BROWSER_HOME));
}
